@page "/"
@rendermode InteractiveServer
@using NCronJob.Dashboard.Services
@using System.Text.Json
@inject DashboardService DashboardService
@inject TimeProvider TimeProvider
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>NCronJob Dashboard</PageTitle>

<div class="dashboard-container">
    <header class="dashboard-header">
        <h1>NCronJob Dashboard</h1>
        <div class="header-info">
            <span class="current-time">Current Time: @currentTime.ToString("yyyy-MM-dd HH:mm:ss")</span>
            <button class="btn-refresh" @onclick="RefreshJobs">Refresh</button>
        </div>
    </header>

    <nav class="dashboard-tabs">
        <button class="tab-button @(activeTab == "jobs" ? "active" : "")" @onclick='() => SetActiveTab("jobs")'>
            Scheduled Jobs
        </button>
        <button class="tab-button @(activeTab == "trigger" ? "active" : "")" @onclick='() => SetActiveTab("trigger")'>
            Trigger Job
        </button>
        <button class="tab-button @(activeTab == "activity" ? "active" : "")" @onclick='() => SetActiveTab("activity")'>
            Activity Log
        </button>
    </nav>

    @if (errorMessage != null)
    {
        <div class="alert alert-error">
            <strong>Error:</strong> @errorMessage
            <button class="btn-close" @onclick="() => errorMessage = null">×</button>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="alert alert-success">
            <strong>Success:</strong> @successMessage
            <button class="btn-close" @onclick="() => successMessage = null">×</button>
        </div>
    }

    <div class="dashboard-content">
        @if (activeTab == "jobs")
        {
            <section class="jobs-section">
                <h2>Scheduled Jobs (@jobs.Count)</h2>
                
                @if (jobs.Count == 0)
                {
                    <div class="no-jobs">
                        <p>No scheduled jobs found.</p>
                    </div>
                }
                else
                {
                    <div class="jobs-table">
                        <div class="table-header">
                            <div class="cell cell-name">Name</div>
                            <div class="cell cell-cron">CRON Expression</div>
                            <div class="cell cell-next">Next Execution</div>
                            <div class="cell cell-status">Status</div>
                            <div class="cell cell-actions">Actions</div>
                        </div>
                        @foreach (var job in jobs)
                        {
                            <div class="table-row @(job.IsEnabled ? "" : "disabled-job")">
                                <div class="cell cell-name">
                                    <div class="job-name">@job.Name</div>
                                    @if (!string.IsNullOrEmpty(job.TypeName))
                                    {
                                        <div class="job-type">@job.TypeName</div>
                                    }
                                </div>
                                <div class="cell cell-cron">
                                    <code>@job.CronExpression</code>
                                    <div class="timezone">@job.TimeZone.Id</div>
                                </div>
                                <div class="cell cell-next">
                                    @if (job.NextExecution.HasValue)
                                    {
                                        <div class="next-execution">
                                            @job.NextExecution.Value.ToString("yyyy-MM-dd HH:mm:ss")
                                        </div>
                                        <div class="time-until">
                                            @GetTimeUntil(job.NextExecution.Value)
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="no-schedule">N/A</span>
                                    }
                                </div>
                                <div class="cell cell-status">
                                    @if (job.IsEnabled)
                                    {
                                        <span class="status-badge status-enabled">Enabled</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-disabled">Disabled</span>
                                    }
                                </div>
                                <div class="cell cell-actions">
                                    <div class="action-buttons">
                                        @if (job.IsEnabled)
                                        {
                                            <button class="btn btn-secondary" @onclick="() => DisableJob(job.Name)">Disable</button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-primary" @onclick="() => EnableJob(job.Name)">Enable</button>
                                        }
                                        <button class="btn btn-danger" @onclick="() => RemoveJob(job.Name)">Remove</button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </section>
        }
        else if (activeTab == "trigger")
        {
            <section class="trigger-section">
                <h2>Trigger Instant Job</h2>
                
                <div class="trigger-form">
                    <div class="form-group">
                        <label for="job-select">Select Job:</label>
                        <select id="job-select" class="form-control" @bind="selectedJobForTrigger">
                            <option value="">-- Select a job --</option>
                            @{
                                var jobNames = jobs.Select(job => job.Name);
                                foreach (var jobName in jobNames)
                                {
                                    <option value="@jobName">@jobName</option>
                                }
                            }
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="parameter-input">Parameter (JSON format):</label>
                        <textarea id="parameter-input" 
                                  class="parameter-input" 
                                  @bind="triggerParameter" 
                                  placeholder='{"key": "value"}' 
                                  rows="5"></textarea>
                    </div>
                    
                    @if (triggerError != null)
                    {
                        <div class="trigger-error">@triggerError</div>
                    }
                    
                    <div class="form-actions">
                        <button class="btn btn-primary" @onclick="TriggerJob" disabled="@string.IsNullOrEmpty(selectedJobForTrigger)">
                            Trigger Now
                        </button>
                    </div>
                </div>
            </section>
        }
        else if (activeTab == "activity")
        {
            <section class="activity-section">
                <h2>Recent Activity</h2>
                <div class="activity-log">
                    @if (recentActivity.Count == 0)
                    {
                        <div class="no-activity">
                            <p>No recent activity.</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var activity in recentActivity.TakeLast(50).Reverse())
                        {
                            <div class="activity-item activity-@activity.State.ToString().ToLower()">
                                <span class="activity-time">@activity.Timestamp.ToString("HH:mm:ss")</span>
                                <span class="activity-job">@(activity.Name ?? activity.Type?.Name ?? "Unknown")</span>
                                <span class="activity-state">@activity.State</span>
                            </div>
                        }
                    }
                </div>
            </section>
        }
    </div>
</div>

@code {
    private string activeTab = "jobs";
    private List<JobInfo> jobs = new();
    private readonly List<ExecutionProgress> recentActivity = new();
    private DateTimeOffset currentTime = DateTimeOffset.UtcNow;
    private string? errorMessage;
    private string? successMessage;
    private IDisposable? progressSubscription;
    private System.Threading.Timer? refreshTimer;
    
    private string? selectedJobForTrigger;
    private string? triggerParameter;
    private string? triggerError;

    protected override void OnInitialized()
    {
        RefreshJobs();
        
        progressSubscription = DashboardService.SubscribeToJobProgress(progress =>
        {
            recentActivity.Add(progress);
            if (recentActivity.Count > 200)
            {
                recentActivity.RemoveAt(0);
            }
            InvokeAsync(StateHasChanged);
        });

        refreshTimer = new System.Threading.Timer(_ =>
        {
            currentTime = TimeProvider.GetUtcNow();
            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private void RefreshJobs()
    {
        try
        {
            jobs = DashboardService.GetAllJobs().ToList();
            currentTime = TimeProvider.GetUtcNow();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load jobs: {ex.Message}";
        }
    }

    private void EnableJob(string jobName)
    {
        try
        {
            DashboardService.EnableJob(jobName);
            successMessage = $"Job '{jobName}' has been enabled.";
            RefreshJobs();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to enable job: {ex.Message}";
        }
    }

    private void DisableJob(string jobName)
    {
        try
        {
            DashboardService.DisableJob(jobName);
            successMessage = $"Job '{jobName}' has been disabled.";
            RefreshJobs();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to disable job: {ex.Message}";
        }
    }

    private void RemoveJob(string jobName)
    {
        try
        {
            DashboardService.RemoveJob(jobName);
            successMessage = $"Job '{jobName}' has been removed.";
            RefreshJobs();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to remove job: {ex.Message}";
        }
    }

    private void TriggerJob()
    {
        if (string.IsNullOrEmpty(selectedJobForTrigger)) return;

        try
        {
            triggerError = null;
            var correlationId = DashboardService.TriggerInstantJob(selectedJobForTrigger, triggerParameter);
            successMessage = $"Job '{selectedJobForTrigger}' triggered successfully (ID: {correlationId}).";
            selectedJobForTrigger = null;
            triggerParameter = null;
        }
        catch (Exception ex)
        {
            triggerError = $"Failed to trigger job: {ex.Message}";
        }
    }

    private string GetTimeUntil(DateTimeOffset nextExecution)
    {
        var timeUntil = nextExecution - currentTime;
        if (timeUntil.TotalSeconds < 0)
        {
            return "Overdue";
        }
        else if (timeUntil.TotalMinutes < 1)
        {
            return $"in {(int)timeUntil.TotalSeconds}s";
        }
        else if (timeUntil.TotalHours < 1)
        {
            return $"in {(int)timeUntil.TotalMinutes}m";
        }
        else if (timeUntil.TotalDays < 1)
        {
            return $"in {timeUntil.Hours}h {timeUntil.Minutes}m";
        }
        else
        {
            return $"in {timeUntil.Days}d {timeUntil.Hours}h";
        }
    }

    public void Dispose()
    {
        progressSubscription?.Dispose();
        refreshTimer?.Dispose();
    }
}
