@page "/ncronjob-dashboard"
@rendermode InteractiveServer
@using NCronJob.Dashboard.Services
@using System.Text.Json
@inject DashboardService DashboardService
@inject TimeProvider TimeProvider
@implements IDisposable

<PageTitle>NCronJob Dashboard</PageTitle>

<div class="dashboard-container">
    <header class="dashboard-header">
        <h1>NCronJob Dashboard</h1>
        <div class="header-info">
            <span class="current-time">Current Time: @currentTime.ToString("yyyy-MM-dd HH:mm:ss")</span>
            <button class="btn-refresh" @onclick="RefreshJobs">Refresh</button>
        </div>
    </header>

    @if (errorMessage != null)
    {
        <div class="alert alert-error">
            <strong>Error:</strong> @errorMessage
            <button class="btn-close" @onclick="() => errorMessage = null">×</button>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="alert alert-success">
            <strong>Success:</strong> @successMessage
            <button class="btn-close" @onclick="() => successMessage = null">×</button>
        </div>
    }

    <div class="dashboard-content">
        <section class="jobs-section">
            <h2>Scheduled Jobs (@jobs.Count)</h2>
            
            @if (jobs.Count == 0)
            {
                <div class="no-jobs">
                    <p>No scheduled jobs found.</p>
                </div>
            }
            else
            {
                <div class="jobs-table">
                    <div class="table-header">
                        <div class="cell cell-name">Name</div>
                        <div class="cell cell-cron">CRON Expression</div>
                        <div class="cell cell-next">Next Execution</div>
                        <div class="cell cell-status">Status</div>
                        <div class="cell cell-actions">Actions</div>
                    </div>
                    @foreach (var job in jobs)
                    {
                        <div class="table-row @(job.IsEnabled ? "" : "disabled-job")">
                            <div class="cell cell-name">
                                <div class="job-name">@job.Name</div>
                                @if (!string.IsNullOrEmpty(job.TypeName))
                                {
                                    <div class="job-type">@job.TypeName</div>
                                }
                            </div>
                            <div class="cell cell-cron">
                                <code>@job.CronExpression</code>
                                <div class="timezone">@job.TimeZone.Id</div>
                            </div>
                            <div class="cell cell-next">
                                @if (job.NextExecution.HasValue)
                                {
                                    <div class="next-execution">
                                        @job.NextExecution.Value.ToString("yyyy-MM-dd HH:mm:ss")
                                    </div>
                                    <div class="time-until">
                                        @GetTimeUntil(job.NextExecution.Value)
                                    </div>
                                }
                                else
                                {
                                    <span class="no-schedule">N/A</span>
                                }
                            </div>
                            <div class="cell cell-status">
                                @if (job.IsEnabled)
                                {
                                    <span class="status-badge status-enabled">Enabled</span>
                                }
                                else
                                {
                                    <span class="status-badge status-disabled">Disabled</span>
                                }
                            </div>
                            <div class="cell cell-actions">
                                <div class="action-buttons">
                                    @if (job.IsEnabled)
                                    {
                                        <button class="btn btn-secondary" @onclick="() => DisableJob(job.Name)">Disable</button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-primary" @onclick="() => EnableJob(job.Name)">Enable</button>
                                    }
                                    <button class="btn btn-info" @onclick="() => ShowTriggerDialog(job)">Trigger</button>
                                    <button class="btn btn-danger" @onclick="() => RemoveJob(job.Name)">Remove</button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </section>

        <section class="activity-section">
            <h2>Recent Activity</h2>
            <div class="activity-log">
                @if (recentActivity.Count == 0)
                {
                    <div class="no-activity">
                        <p>No recent activity.</p>
                    </div>
                }
                else
                {
                    @foreach (var activity in recentActivity.TakeLast(20).Reverse())
                    {
                        <div class="activity-item activity-@activity.State.ToString().ToLower()">
                            <span class="activity-time">@activity.Timestamp.ToString("HH:mm:ss")</span>
                            <span class="activity-job">@(activity.Name ?? activity.Type?.Name ?? "Unknown")</span>
                            <span class="activity-state">@activity.State</span>
                        </div>
                    }
                }
            </div>
        </section>
    </div>
</div>

@if (showTriggerDialog && selectedJob != null)
{
    <div class="modal-overlay" @onclick="CloseTriggerDialog">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Trigger Job: @selectedJob.Name</h3>
                <button class="btn-close" @onclick="CloseTriggerDialog">×</button>
            </div>
            <div class="modal-body">
                <label for="parameter-input">Parameter (JSON format):</label>
                <textarea id="parameter-input" 
                          class="parameter-input" 
                          @bind="triggerParameter" 
                          placeholder='{"key": "value"}' 
                          rows="5"></textarea>
                @if (triggerError != null)
                {
                    <div class="trigger-error">@triggerError</div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseTriggerDialog">Cancel</button>
                <button class="btn btn-primary" @onclick="TriggerSelectedJob">Trigger Now</button>
            </div>
        </div>
    </div>
}

@code {
    private List<JobInfo> jobs = new();
    private readonly List<ExecutionProgress> recentActivity = new();
    private DateTimeOffset currentTime = DateTimeOffset.UtcNow;
    private string? errorMessage;
    private string? successMessage;
    private IDisposable? progressSubscription;
    private System.Threading.Timer? refreshTimer;
    
    private bool showTriggerDialog;
    private JobInfo? selectedJob;
    private string? triggerParameter;
    private string? triggerError;

    protected override void OnInitialized()
    {
        RefreshJobs();
        
        progressSubscription = DashboardService.SubscribeToJobProgress(progress =>
        {
            recentActivity.Add(progress);
            if (recentActivity.Count > 100)
            {
                recentActivity.RemoveAt(0);
            }
            InvokeAsync(StateHasChanged);
        });

        refreshTimer = new System.Threading.Timer(_ =>
        {
            currentTime = TimeProvider.GetUtcNow();
            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private void RefreshJobs()
    {
        try
        {
            jobs = DashboardService.GetAllJobs().ToList();
            currentTime = TimeProvider.GetUtcNow();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load jobs: {ex.Message}";
        }
    }

    private void EnableJob(string jobName)
    {
        try
        {
            DashboardService.EnableJob(jobName);
            successMessage = $"Job '{jobName}' has been enabled.";
            RefreshJobs();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to enable job: {ex.Message}";
        }
    }

    private void DisableJob(string jobName)
    {
        try
        {
            DashboardService.DisableJob(jobName);
            successMessage = $"Job '{jobName}' has been disabled.";
            RefreshJobs();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to disable job: {ex.Message}";
        }
    }

    private void RemoveJob(string jobName)
    {
        try
        {
            DashboardService.RemoveJob(jobName);
            successMessage = $"Job '{jobName}' has been removed.";
            RefreshJobs();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to remove job: {ex.Message}";
        }
    }

    private void ShowTriggerDialog(JobInfo job)
    {
        selectedJob = job;
        triggerParameter = null;
        triggerError = null;
        showTriggerDialog = true;
    }

    private void CloseTriggerDialog()
    {
        showTriggerDialog = false;
        selectedJob = null;
        triggerParameter = null;
        triggerError = null;
    }

    private void TriggerSelectedJob()
    {
        if (selectedJob == null) return;

        try
        {
            triggerError = null;
            var correlationId = DashboardService.TriggerInstantJob(selectedJob.Name, triggerParameter);
            successMessage = $"Job '{selectedJob.Name}' triggered successfully (ID: {correlationId}).";
            CloseTriggerDialog();
        }
        catch (Exception ex)
        {
            triggerError = $"Failed to trigger job: {ex.Message}";
        }
    }

    private string GetTimeUntil(DateTimeOffset nextExecution)
    {
        var timeUntil = nextExecution - currentTime;
        if (timeUntil.TotalSeconds < 0)
        {
            return "Overdue";
        }
        else if (timeUntil.TotalMinutes < 1)
        {
            return $"in {(int)timeUntil.TotalSeconds}s";
        }
        else if (timeUntil.TotalHours < 1)
        {
            return $"in {(int)timeUntil.TotalMinutes}m";
        }
        else if (timeUntil.TotalDays < 1)
        {
            return $"in {timeUntil.Hours}h {timeUntil.Minutes}m";
        }
        else
        {
            return $"in {timeUntil.Days}d {timeUntil.Hours}h";
        }
    }

    public void Dispose()
    {
        progressSubscription?.Dispose();
        refreshTimer?.Dispose();
    }
}
